<!DOCTYPE html><html lang="zh-CN"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>链下工作机 · Substrate Developer Hub</title><meta name="viewport" content="width=device-width"/><meta name="generator" content="Docusaurus"/><meta name="description" content="This article covers the technical aspects of using off-chain workers in a Substrate runtime. For a conceptual overview of off-chain workers see the [Conceptual Guide](../learn-substrate/off-chain-features#off-chain-workers)."/><meta name="docsearch:language" content="zh-CN"/><meta property="og:title" content="链下工作机 · Substrate Developer Hub"/><meta property="og:type" content="website"/><meta property="og:url" content="https://substrate-developer-hub.github.io//"/><meta property="og:description" content="This article covers the technical aspects of using off-chain workers in a Substrate runtime. For a conceptual overview of off-chain workers see the [Conceptual Guide](../learn-substrate/off-chain-features#off-chain-workers)."/><meta property="og:image" content="https://substrate-developer-hub.github.io/img/substrate-dev-hub-card.png"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://substrate-developer-hub.github.io/img/substrate-dev-hub-card.png"/><link rel="shortcut icon" href="/img/favicon.png"/><link rel="stylesheet" href="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.css"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script type="text/javascript" src="/js/clipboard.min.js"></script><script type="text/javascript" src="/js/code-block-buttons.js"></script><script type="text/javascript" src="/js/load.js"></script><script type="text/javascript" src="/js/redirect-next.js"></script><script type="text/javascript" src="/js/config.js" defer=""></script><script type="text/javascript" src="/js/klaro.min.js" defer=""></script><script src="https://unpkg.com/vanilla-back-to-top@7.1.14/dist/vanilla-back-to-top.min.js"></script><script>
        document.addEventListener('DOMContentLoaded', function() {
          addBackToTop(
            {"zIndex":100}
          )
        });
        </script><script src="/js/scrollSpy.js"></script><link rel="stylesheet" href="/css/prism.css"/><link rel="stylesheet" href="/css/main.css"/><script src="/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/zh-CN"><img class="logo" src="/img/Substrate-logo.svg" alt="Substrate Developer Hub"/><h2 class="headerTitleWithLogo">Substrate Developer Hub</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/zh-CN/tutorials" target="_self">教程</a></li><li class="siteNavGroupActive"><a href="/docs/zh-CN/" target="_self">知识库</a></li><li class=""><a href="https://substrate.dev/recipes/" target="_self">进阶菜谱</a></li><li class=""><a href="https://substrate.dev/rustdocs/" target="_self">API 文档</a></li><li class="navSearchWrapper reactNavSearchWrapper"><input type="text" id="search_input_react" placeholder="Search" title="Search"/></li><span><li><a id="languages-menu" href="#"><img class="languages-icon" src="/img/language.svg" alt="Languages icon"/>简体中文</a><div id="languages-dropdown" class="hide"><ul id="languages-dropdown-items"><li><a href="/docs/en/knowledgebase/runtime/off-chain-workers">English</a></li><li><a href="https://crowdin.com/project/substrate-developer-hub" target="_blank" rel="noreferrer noopener">协助翻译</a></li></ul></div></li><script>
        const languagesMenuItem = document.getElementById("languages-menu");
        const languagesDropDown = document.getElementById("languages-dropdown");
        languagesMenuItem.addEventListener("click", function(event) {
          event.preventDefault();

          if (languagesDropDown.className == "hide") {
            languagesDropDown.className = "visible";
          } else {
            languagesDropDown.className = "hide";
          }
        });
      </script></span></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Runtime</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">开始<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/zh-CN/">总览</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/getting-started/">安装</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/getting-started/windows-users">在 Windows 系统开始</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/getting-started/glossary">词汇表</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">学习 Substrate<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/learn-substrate/extrinsics">Extrinsics</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/learn-substrate/tx-pool">交易池</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/learn-substrate/account-abstractions">账户摘要</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/learn-substrate/session-keys">会话密钥</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/learn-substrate/weight">交易权重</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/learn-substrate/off-chain-features">链下功能</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Runtime<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/runtime/">Runtime 总览</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/runtime/primitives">Runtime 的基本类型</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/runtime/frame">FRAME</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/runtime/pallets">Pallets</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/runtime/macros">Runtime宏</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/runtime/metadata">Runtime 元数据</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/runtime/storage">Runtime 存储</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/runtime/origin">Runtime 来源</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/runtime/execution">Runtime 执行流程</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/runtime/events">Runtime事件</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/runtime/errors">Runtime 错误</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/runtime/fees">交易费用</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/docs/zh-CN/knowledgebase/runtime/off-chain-workers">链下工作机</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/runtime/debugging">调试</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/runtime/tests">Runtime 测试</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/runtime/randomness">链上随机生成</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/runtime/upgrades">Runtime 升级</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">智能合约<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/smart-contracts/overview">总览</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/smart-contracts/">ink! 智能合约</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/smart-contracts/ink-fundamentals">ink! 概念</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/smart-contracts/ink-development">ink! 开发</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/smart-contracts/evm-pallet">EVM 模块</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/smart-contracts/faq">ink! 常问问题</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">整合<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/integrate/polkadot-js">Polkadot-JS</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/integrate/libraries">客户端库</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/integrate/chain-spec">链规范</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/integrate/subkey">Subkey 工具</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/integrate/memory-profiling">内存分析</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">进阶<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/advanced/codec">SCALE 编解码器</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/advanced/consensus">共识机制</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/advanced/block-import">区块导入过程</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/advanced/executor">执行器</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/advanced/cryptography">密码学</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/advanced/storage">存储</a></li><li class="navListItem"><a class="navItem" href="/docs/zh-CN/knowledgebase/advanced/ss58-address-format">SS58 地址格式</a></li></ul></div><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">贡献<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/docs/zh-CN/contribute/help-translate">协助翻译</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><a class="edit-page-link button" href="https://crowdin.com/project/substrate-developer-hub/zh-CN" target="_blank" rel="noreferrer noopener">Translate</a><h1 id="__docusaurus" class="postHeaderTitle">链下工作机</h1></header><article><div><span><p>This article covers the technical aspects of using off-chain workers in a Substrate runtime. For a conceptual overview of off-chain workers see the <a href="../learn-substrate/off-chain-features#off-chain-workers">Conceptual Guide</a>.</p>
<h2><a class="anchor" aria-hidden="true" id="using-off-chain-workers-in-the-runtime"></a><a href="#using-off-chain-workers-in-the-runtime" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Using Off-Chain Workers in the Runtime</h2>
<p>You can create logic for an off-chain worker by putting it in its own pallet. We will call this pallet <code>my_offchain_worker</code> for this example. It belongs in your runtime, so <code>runtime/src/my_offchain_worker.rs</code>.</p>
<p>First, include the following modules:</p>
<pre><code class="hljs css language-rust"><span class="token comment">// For better debugging (printout) support</span>
<span class="token keyword">use</span> <span class="token namespace">support<span class="token punctuation">::</span></span><span class="token punctuation">{</span> debug<span class="token punctuation">,</span> dispatch <span class="token punctuation">}</span><span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">system<span class="token punctuation">::</span></span>offchain<span class="token punctuation">;</span>
<span class="token keyword">use</span> <span class="token namespace">sp_runtime<span class="token punctuation">::</span>transaction_validity<span class="token punctuation">::</span></span><span class="token punctuation">{</span>
  <span class="token class-name">TransactionValidity</span><span class="token punctuation">,</span> <span class="token class-name">TransactionLongevity</span><span class="token punctuation">,</span> <span class="token class-name">ValidTransaction</span><span class="token punctuation">,</span> <span class="token class-name">InvalidTransaction</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre>
<p>Include the following associated types in your pallet's configuration trait for sending signed and unsigned transactions from an off-chain worker.</p>
<pre><code class="hljs css language-rust"><span class="token keyword">pub</span> <span class="token keyword">trait</span> <span class="token class-name">Trait</span><span class="token punctuation">:</span> <span class="token namespace">timestamp<span class="token punctuation">::</span></span><span class="token class-name">Trait</span> <span class="token operator">+</span> <span class="token namespace">system<span class="token punctuation">::</span></span><span class="token class-name">Trait</span> <span class="token punctuation">{</span>
  <span class="token comment">/// The overarching event type.</span>
  <span class="token keyword">type</span> <span class="token class-name">Event</span><span class="token punctuation">:</span> <span class="token class-name">From</span><span class="token operator">&lt;</span><span class="token class-name">Event</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">>></span> <span class="token operator">+</span> <span class="token class-name">Into</span><span class="token operator">&lt;&lt;</span><span class="token keyword">Self</span> <span class="token keyword">as</span> <span class="token namespace">system<span class="token punctuation">::</span></span><span class="token class-name">Trait</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token class-name">Event</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token keyword">type</span> <span class="token class-name">Call</span><span class="token punctuation">:</span> <span class="token class-name">From</span><span class="token operator">&lt;</span><span class="token class-name">Call</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token operator">>></span><span class="token punctuation">;</span>

  <span class="token keyword">type</span> <span class="token class-name">SubmitSignedTransaction</span><span class="token punctuation">:</span> <span class="token namespace">offchain<span class="token punctuation">::</span></span><span class="token class-name">SubmitSignedTransaction</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token keyword">Self</span> <span class="token keyword">as</span> <span class="token class-name">Trait</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token class-name">Call</span><span class="token operator">></span><span class="token punctuation">;</span>
  <span class="token keyword">type</span> <span class="token class-name">SubmitUnsignedTransaction</span><span class="token punctuation">:</span> <span class="token namespace">offchain<span class="token punctuation">::</span></span><span class="token class-name">SubmitUnsignedTransaction</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token keyword">Self</span> <span class="token keyword">as</span> <span class="token class-name">Trait</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token class-name">Call</span><span class="token operator">></span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Inside the <code>decl_module!</code> block, define the <code>offchain_worker</code> function. This function serves as the entry point of the off-chain worker and runs after every block import.</p>
<pre><code class="hljs css language-rust"><span class="token macro property">decl_module!</span> <span class="token punctuation">{</span>
  <span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Module</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Trait</span><span class="token operator">></span> <span class="token keyword">for</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">Call</span> <span class="token keyword">where</span> origin<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">::</span><span class="token class-name">Origin</span> <span class="token punctuation">{</span>

    <span class="token comment">// --snip--</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">offchain_worker</span><span class="token punctuation">(</span>block<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">::</span><span class="token class-name">BlockNumber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token macro property">info!</span><span class="token punctuation">(</span><span class="token string">"Hello World."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>By default, the off-chain worker doesn't have direct access to user keys (even in the development environment), but can only access app-specific subkeys for security reasons. You need to define the <code>KeyTypeId</code> at the top of your runtime that is used to group your app-specific subkeys as follows:</p>
<pre><code class="hljs css language-rust"><span class="token comment">// The key type ID can be any 4-character string</span>
<span class="token keyword">pub</span> <span class="token keyword">const</span> <span class="token constant">KEY_TYPE</span><span class="token punctuation">:</span> <span class="token class-name">KeyTypeId</span> <span class="token operator">=</span> <span class="token class-name">KeyTypeId</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token string">b"abcd"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// --snip--</span>

<span class="token keyword">pub</span> <span class="token keyword">mod</span> <span class="token module-declaration namespace">crypto</span> <span class="token punctuation">{</span>
  <span class="token keyword">pub</span> <span class="token keyword">use</span> <span class="token keyword">super</span><span class="token punctuation">::</span><span class="token constant">KEY_TYPE</span><span class="token punctuation">;</span>
  <span class="token keyword">use</span> <span class="token namespace">sp_runtime<span class="token punctuation">::</span>app_crypto<span class="token punctuation">::</span></span><span class="token punctuation">{</span>app_crypto<span class="token punctuation">,</span> sr25519<span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token macro property">app_crypto!</span><span class="token punctuation">(</span>sr25519<span class="token punctuation">,</span> <span class="token constant">KEY_TYPE</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>As with any other pallet, your runtime must implement the pallet's configuration trait. Go to your runtime's <code>lib.rs</code> at <code>runtime/src/lib.rs</code>.</p>
<pre><code class="hljs css language-rust"><span class="token comment">// Define the transaction signer using the key definition</span>
<span class="token keyword">type</span> <span class="token class-name">SubmitTransaction</span> <span class="token operator">=</span> <span class="token namespace">system<span class="token punctuation">::</span>offchain<span class="token punctuation">::</span></span><span class="token class-name">TransactionSubmitter</span><span class="token operator">&lt;</span>
  <span class="token namespace">offchain_pallet<span class="token punctuation">::</span>crypto<span class="token punctuation">::</span></span><span class="token class-name">Public</span><span class="token punctuation">,</span> <span class="token class-name">Runtime</span><span class="token punctuation">,</span> <span class="token class-name">UncheckedExtrinsic</span><span class="token operator">></span><span class="token punctuation">;</span>

<span class="token keyword">impl</span> <span class="token namespace">offchain_pallet<span class="token punctuation">::</span></span><span class="token class-name">Trait</span> <span class="token keyword">for</span> <span class="token class-name">Runtime</span> <span class="token punctuation">{</span>
  <span class="token keyword">type</span> <span class="token class-name">Event</span> <span class="token operator">=</span> <span class="token class-name">Event</span><span class="token punctuation">;</span>
  <span class="token keyword">type</span> <span class="token class-name">Call</span> <span class="token operator">=</span> <span class="token class-name">Call</span><span class="token punctuation">;</span>

  <span class="token comment">// To use signed transactions in your runtime</span>
  <span class="token keyword">type</span> <span class="token class-name">SubmitSignedTransaction</span> <span class="token operator">=</span> <span class="token class-name">SubmitTransaction</span><span class="token punctuation">;</span>

  <span class="token comment">// To use unsigned transactions in your runtime</span>
  <span class="token keyword">type</span> <span class="token class-name">SubmitUnsignedTransaction</span> <span class="token operator">=</span> <span class="token class-name">SubmitTransaction</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Then implement the <code>system::offchain::CreateTransaction</code> trait for the runtime. Still in your <code>lib.rs</code>:</p>
<pre><code class="hljs css language-rust"><span class="token keyword">use</span> <span class="token namespace">sp_runtime<span class="token punctuation">::</span></span>transaction_validity<span class="token punctuation">;</span>

<span class="token comment">// --snip--</span>

<span class="token keyword">impl</span> <span class="token namespace">system<span class="token punctuation">::</span>offchain<span class="token punctuation">::</span></span><span class="token class-name">CreateTransaction</span><span class="token operator">&lt;</span><span class="token class-name">Runtime</span><span class="token punctuation">,</span> <span class="token class-name">UncheckedExtrinsic</span><span class="token operator">></span> <span class="token keyword">for</span> <span class="token class-name">Runtime</span> <span class="token punctuation">{</span>
  <span class="token keyword">type</span> <span class="token class-name">Public</span> <span class="token operator">=</span> <span class="token operator">&lt;</span><span class="token class-name">Signature</span> <span class="token keyword">as</span> <span class="token class-name">Verify</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token class-name">Signer</span><span class="token punctuation">;</span>
  <span class="token keyword">type</span> <span class="token class-name">Signature</span> <span class="token operator">=</span> <span class="token class-name">Signature</span><span class="token punctuation">;</span>

  <span class="token keyword">fn</span> <span class="token function-definition function">create_transaction</span><span class="token operator">&lt;</span><span class="token class-name">TSigner</span><span class="token punctuation">:</span> <span class="token namespace">system<span class="token punctuation">::</span>offchain<span class="token punctuation">::</span></span><span class="token class-name">Signer</span><span class="token operator">&lt;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Public</span><span class="token punctuation">,</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Signature</span><span class="token operator">>></span> <span class="token punctuation">(</span>
    call<span class="token punctuation">:</span> <span class="token class-name">Call</span><span class="token punctuation">,</span>
    public<span class="token punctuation">:</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Public</span><span class="token punctuation">,</span>
    account<span class="token punctuation">:</span> <span class="token class-name">AccountId</span><span class="token punctuation">,</span>
    index<span class="token punctuation">:</span> <span class="token class-name">Index</span><span class="token punctuation">,</span>
  <span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Option</span><span class="token operator">&lt;</span><span class="token punctuation">(</span><span class="token class-name">Call</span><span class="token punctuation">,</span> <span class="token operator">&lt;</span><span class="token class-name">UncheckedExtrinsic</span> <span class="token keyword">as</span> <span class="token namespace">sp_runtime<span class="token punctuation">::</span>traits<span class="token punctuation">::</span></span><span class="token class-name">Extrinsic</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token class-name">SignaturePayload</span><span class="token punctuation">)</span><span class="token operator">></span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> period <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> current_block <span class="token operator">=</span> <span class="token class-name">System</span><span class="token punctuation">::</span><span class="token function">block_number</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">saturated_into</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token keyword">u64</span><span class="token operator">></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> tip <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> extra<span class="token punctuation">:</span> <span class="token class-name">SignedExtra</span> <span class="token operator">=</span> <span class="token punctuation">(</span>
      <span class="token namespace">system<span class="token punctuation">::</span></span><span class="token class-name">CheckVersion</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Runtime</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token namespace">system<span class="token punctuation">::</span></span><span class="token class-name">CheckGenesis</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Runtime</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token namespace">system<span class="token punctuation">::</span></span><span class="token class-name">CheckEra</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Runtime</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span><span class="token namespace">generic<span class="token punctuation">::</span></span><span class="token class-name">Era</span><span class="token punctuation">::</span><span class="token function">mortal</span><span class="token punctuation">(</span>period<span class="token punctuation">,</span> current_block<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token namespace">system<span class="token punctuation">::</span></span><span class="token class-name">CheckNonce</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Runtime</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>index<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token namespace">system<span class="token punctuation">::</span></span><span class="token class-name">CheckWeight</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Runtime</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token namespace">transaction_payment<span class="token punctuation">::</span></span><span class="token class-name">ChargeTransactionPayment</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Runtime</span><span class="token operator">></span><span class="token punctuation">::</span><span class="token function">from</span><span class="token punctuation">(</span>tip<span class="token punctuation">)</span><span class="token punctuation">,</span>
    <span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> raw_payload <span class="token operator">=</span> <span class="token class-name">SignedPayload</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> extra<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">ok</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> signature <span class="token operator">=</span> <span class="token class-name">TSigner</span><span class="token punctuation">::</span><span class="token function">sign</span><span class="token punctuation">(</span>public<span class="token punctuation">,</span> <span class="token operator">&amp;</span>raw_payload<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> address <span class="token operator">=</span> <span class="token class-name">Indices</span><span class="token punctuation">::</span><span class="token function">unlookup</span><span class="token punctuation">(</span>account<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> <span class="token punctuation">(</span>call<span class="token punctuation">,</span> extra<span class="token punctuation">,</span> _<span class="token punctuation">)</span> <span class="token operator">=</span> raw_payload<span class="token punctuation">.</span><span class="token function">deconstruct</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Some</span><span class="token punctuation">(</span><span class="token punctuation">(</span>call<span class="token punctuation">,</span> <span class="token punctuation">(</span>address<span class="token punctuation">,</span> signature<span class="token punctuation">,</span> extra<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Inside the <code>contruct_runtime!</code> macro where you put all the various pallets as part of your runtime, add the additional parameter <code>ValidateUnsigned</code> if you are using unsigned transactions in off-chain workers. You will need to write custom <a href="../learn-substrate/extrinsics">validation logic</a> for this.</p>
<pre><code class="hljs css language-rust"><span class="token macro property">construct_runtime!</span><span class="token punctuation">(</span>
  <span class="token keyword">pub</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">Runtime</span> <span class="token keyword">where</span>
    <span class="token class-name">Block</span> <span class="token operator">=</span> <span class="token class-name">Block</span><span class="token punctuation">,</span>
    <span class="token class-name">NodeBlock</span> <span class="token operator">=</span> <span class="token namespace">opaque<span class="token punctuation">::</span></span><span class="token class-name">Block</span><span class="token punctuation">,</span>
    <span class="token class-name">UncheckedExtrinsic</span> <span class="token operator">=</span> <span class="token class-name">UncheckedExtrinsic</span>
  <span class="token punctuation">{</span>
    <span class="token comment">// --snip--</span>

    <span class="token comment">// To use unsigned transactions</span>
    <span class="token class-name">OffchainPallet</span><span class="token punctuation">:</span> <span class="token namespace">offchain_pallet<span class="token punctuation">::</span></span><span class="token punctuation">{</span> <span class="token class-name">Module</span><span class="token punctuation">,</span> <span class="token class-name">Call</span><span class="token punctuation">,</span> <span class="token class-name">Storage</span><span class="token punctuation">,</span> <span class="token class-name">Event</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token namespace">transaction_validity<span class="token punctuation">::</span></span><span class="token class-name">ValidateUnsigned</span> <span class="token punctuation">}</span>

    <span class="token comment">// If you are only using signed transactions, it can just be:</span>
    <span class="token comment">// OffchainPallet: offchain_pallet::{ Module, Call, Storage, Event&lt;T> }</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h2><a class="anchor" aria-hidden="true" id="insert-keys-in-servicers"></a><a href="#insert-keys-in-servicers" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Insert Keys in <code>service.rs</code></h2>
<p>We have specified a local keystore with <code>KeyTypeId</code> to store app-specific keys that are accessible by the off-chain worker for signing transactions. You will need to add keys in one of the following two ways.</p>
<h3><a class="anchor" aria-hidden="true" id="选项-1（开发阶段）：添加第一个用户密钥作为应用子密钥"></a><a href="#选项-1（开发阶段）：添加第一个用户密钥作为应用子密钥" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>选项 1（开发阶段）：添加第一个用户密钥作为应用子密钥</h3>
<p>In a development environment, you can add the first user's key as the app sub-key. Update the <code>node/src/service.rs</code> as follows.</p>
<pre><code class="hljs css language-rust"><span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">new_full</span><span class="token operator">&lt;</span><span class="token class-name">C</span><span class="token punctuation">:</span> <span class="token class-name">Send</span> <span class="token operator">+</span> <span class="token class-name">Default</span> <span class="token operator">+</span> <span class="token lifetime-annotation symbol">'static</span><span class="token operator">></span><span class="token punctuation">(</span>config<span class="token punctuation">:</span> <span class="token class-name">Configuration</span><span class="token operator">&lt;</span><span class="token class-name">C</span><span class="token punctuation">,</span> <span class="token class-name">GenesisConfig</span><span class="token operator">></span><span class="token punctuation">)</span>
  <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token keyword">impl</span> <span class="token class-name">AbstractService</span><span class="token punctuation">,</span> <span class="token class-name">ServiceError</span><span class="token operator">></span>
<span class="token punctuation">{</span>
  <span class="token comment">// --snip--</span>

  <span class="token comment">// This clones the key for Alice.</span>
  <span class="token keyword">let</span> dev_seed <span class="token operator">=</span> config<span class="token punctuation">.</span>dev_key_seed<span class="token punctuation">.</span><span class="token function">clone</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  <span class="token comment">// --snip--</span>

  <span class="token keyword">let</span> service <span class="token operator">=</span> builder<span class="token punctuation">.</span><span class="token function">with_network_protocol</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>_<span class="token closure-punctuation punctuation">|</span></span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">NodeProtocol</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">with_finality_proof_provider</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>client<span class="token punctuation">,</span> backend<span class="token closure-punctuation punctuation">|</span></span>
      <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">Arc</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span><span class="token class-name">GrandpaFinalityProofProvider</span><span class="token punctuation">::</span><span class="token function">new</span><span class="token punctuation">(</span>backend<span class="token punctuation">,</span> client<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token keyword">as</span> _<span class="token punctuation">)</span>
    <span class="token punctuation">)</span><span class="token operator">?</span>
    <span class="token punctuation">.</span><span class="token function">build</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

  <span class="token comment">// Add the following section to add the key to the keystore.</span>
  <span class="token keyword">if</span> <span class="token keyword">let</span> <span class="token class-name">Some</span><span class="token punctuation">(</span>seed<span class="token punctuation">)</span> <span class="token operator">=</span> dev_seed <span class="token punctuation">{</span>
    service
      <span class="token punctuation">.</span><span class="token function">keystore</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">insert_ephemeral_from_seed_by_type</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token namespace">runtime<span class="token punctuation">::</span>offchain_pallet<span class="token punctuation">::</span>crypto<span class="token punctuation">::</span></span><span class="token class-name">Pair</span><span class="token operator">></span><span class="token punctuation">(</span>
        <span class="token operator">&amp;</span>seed<span class="token punctuation">,</span>
        <span class="token namespace">runtime<span class="token punctuation">::</span>offchain_pallet<span class="token punctuation">::</span></span><span class="token constant">KEY_TYPE</span><span class="token punctuation">,</span>
      <span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">expect</span><span class="token punctuation">(</span><span class="token string">"Dev Seed should always succeed."</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>Then you will be able to sign transactions. This is good for <strong>development only</strong>.</p>
<h3><a class="anchor" aria-hidden="true" id="option-2-add-an-app-subkey-via-cli"></a><a href="#option-2-add-an-app-subkey-via-cli" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Option 2: Add an App Subkey via CLI</h3>
<p>In a more realistic setting, after setting up your Substrate node, you can add a new app subkey via the command line interface as follows.</p>
<pre><code class="hljs css language-bash"><span class="hljs-comment"># Generate a new account</span>
$ subkey generate

<span class="hljs-comment"># Submit a new key via RPC</span>
$ curl http://localhost:9933 -H <span class="hljs-string">"Content-Type:application/json;charset=utf-8"</span> -d \
  <span class="hljs-string">'{
    "jsonrpc":"2.0",
    "id":1,
    "method":"author_insertKey",
    "params": [
      "&lt;YourKeyTypeId&gt;",
      "&lt;YourSeedPhrase&gt;",
      "&lt;YourPublicKey&gt;"
    ]
  }'</span>
</code></pre>
<p>If you enter the command and parameters correctly, the node will return a JSON response as follows.</p>
<pre><code class="hljs css language-json">{ <span class="hljs-attr">"jsonrpc"</span>: <span class="hljs-string">"2.0"</span>, <span class="hljs-attr">"result"</span>: <span class="hljs-literal">null</span>, <span class="hljs-attr">"id"</span>: <span class="hljs-number">1</span> }
</code></pre>
<p>A new key is now added in the local keystore.</p>
<h2><a class="anchor" aria-hidden="true" id="signed-transactions"></a><a href="#signed-transactions" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Signed Transactions</h2>
<p>Now you are ready to to make a signed transaction from the off-chain worker. Go back to your pallet in <code>my_offchain_worker.rs</code>.</p>
<pre><code class="hljs css language-rust"><span class="token macro property">decl_module!</span> <span class="token punctuation">{</span>
  <span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Module</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Trait</span><span class="token operator">></span> <span class="token keyword">for</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">Call</span> <span class="token keyword">where</span> origin<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">::</span><span class="token class-name">Origin</span> <span class="token punctuation">{</span>
    <span class="token comment">// --snip--</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">onchain_callback</span><span class="token punctuation">(</span>origin<span class="token punctuation">,</span> _block<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">::</span><span class="token class-name">BlockNumber</span><span class="token punctuation">,</span> input<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">dispatch<span class="token punctuation">::</span></span><span class="token class-name">Result</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> who <span class="token operator">=</span> <span class="token function">ensure_signed</span><span class="token punctuation">(</span>origin<span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>
      <span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token macro property">info!</span><span class="token punctuation">(</span><span class="token string">"{:?}"</span><span class="token punctuation">,</span> <span class="token namespace">core<span class="token punctuation">::</span></span><span class="token keyword">str</span><span class="token punctuation">::</span><span class="token function">from_utf8</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>input<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">offchain_worker</span><span class="token punctuation">(</span>block<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">::</span><span class="token class-name">BlockNumber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Here we specify the function to be called back on-chain in next block import.</span>
      <span class="token keyword">let</span> call <span class="token operator">=</span> <span class="token class-name">Call</span><span class="token punctuation">::</span><span class="token function">onchain_callback</span><span class="token punctuation">(</span>block<span class="token punctuation">,</span> <span class="token string">b"hello world!"</span><span class="token punctuation">.</span><span class="token function">to_vec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">T</span><span class="token punctuation">::</span><span class="token class-name">SubmitSignedTransaction</span><span class="token punctuation">::</span><span class="token function">submit_signed</span><span class="token punctuation">(</span>call<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>After having defined the on-chain callback function, in the off-chain worker you can specify that function to be called back in the next block import phase. You then submit a signed transaction to the node.</p>
<p>If you look at the implementation of <code>fn system::offchain::submit_signed</code> in the <a href="https://github.com/paritytech/substrate/blob/a98625501be68cc3084e666497c16b111741dded/frame/system/src/offchain.rs#L106-L115">Substrate codebase</a>, you will see it is calling the on-chain callback for each key in the local keystore. But since you only have one key in the local keystore now, you are calling the function only once.</p>
<p><a href="../learn-substrate/extrinsics#signed-transactions">Learn more about Signed Transactions</a>.</p>
<h2><a class="anchor" aria-hidden="true" id="unsigned-transactions"></a><a href="#unsigned-transactions" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Unsigned Transactions</h2>
<p>With the following code, you are able to send an unsigned transaction back to the chain.</p>
<pre><code class="hljs css language-rust"><span class="token macro property">decl_module!</span> <span class="token punctuation">{</span>
  <span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Module</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Trait</span><span class="token operator">></span> <span class="token keyword">for</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">Call</span> <span class="token keyword">where</span> origin<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">::</span><span class="token class-name">Origin</span> <span class="token punctuation">{</span>
    <span class="token comment">// --snip--</span>

    <span class="token keyword">pub</span> <span class="token keyword">fn</span> <span class="token function-definition function">onchain_callback</span><span class="token punctuation">(</span>_origin<span class="token punctuation">,</span> _block<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">::</span><span class="token class-name">BlockNumber</span><span class="token punctuation">,</span> input<span class="token punctuation">:</span> <span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">></span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token namespace">dispatch<span class="token punctuation">::</span></span><span class="token class-name">Result</span> <span class="token punctuation">{</span>
      <span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token macro property">info!</span><span class="token punctuation">(</span><span class="token string">"{:?}"</span><span class="token punctuation">,</span> <span class="token namespace">core<span class="token punctuation">::</span></span><span class="token keyword">str</span><span class="token punctuation">::</span><span class="token function">from_utf8</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>input<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">fn</span> <span class="token function-definition function">offchain_worker</span><span class="token punctuation">(</span>block<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">::</span><span class="token class-name">BlockNumber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// Here we specify the function to be called back on-chain in next block import.</span>
      <span class="token keyword">let</span> call <span class="token operator">=</span> <span class="token class-name">Call</span><span class="token punctuation">::</span><span class="token function">onchain_callback</span><span class="token punctuation">(</span>block<span class="token punctuation">,</span> <span class="token string">b"hello world!"</span><span class="token punctuation">.</span><span class="token function">to_vec</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token class-name">T</span><span class="token punctuation">::</span><span class="token class-name">SubmitUnsignedTransaction</span><span class="token punctuation">::</span><span class="token function">submit_unsigned</span><span class="token punctuation">(</span>call<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>By default, all unsigned transactions are treated as invalid transactions. You need to add the following code piece in <code>my_offchain_worker.rs</code> to explicitly allow submitting unsigned transactions.</p>
<pre><code class="hljs css language-rust"><span class="token macro property">decl_module!</span> <span class="token punctuation">{</span>
  <span class="token comment">// --snip--</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Trait</span><span class="token operator">></span> <span class="token class-name">Module</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token comment">// --snip--</span>
<span class="token punctuation">}</span>

<span class="token attribute attr-name">#[allow(deprecated)]</span>
<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Trait</span><span class="token operator">></span> <span class="token namespace">support<span class="token punctuation">::</span>unsigned<span class="token punctuation">::</span></span><span class="token class-name">ValidateUnsigned</span> <span class="token keyword">for</span> <span class="token class-name">Module</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">type</span> <span class="token class-name">Call</span> <span class="token operator">=</span> <span class="token class-name">Call</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span><span class="token punctuation">;</span>

  <span class="token keyword">fn</span> <span class="token function-definition function">validate_unsigned</span><span class="token punctuation">(</span>call<span class="token punctuation">:</span> <span class="token operator">&amp;</span><span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token class-name">Call</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">TransactionValidity</span> <span class="token punctuation">{</span>

    <span class="token keyword">match</span> call <span class="token punctuation">{</span>
      <span class="token class-name">Call</span><span class="token punctuation">::</span><span class="token function">onchain_callback</span><span class="token punctuation">(</span>block<span class="token punctuation">,</span> input<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token class-name">Ok</span><span class="token punctuation">(</span><span class="token class-name">ValidTransaction</span> <span class="token punctuation">{</span>
        priority<span class="token punctuation">:</span> <span class="token number">0</span><span class="token punctuation">,</span>
        requires<span class="token punctuation">:</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        provides<span class="token punctuation">:</span> <span class="token macro property">vec!</span><span class="token punctuation">[</span><span class="token punctuation">(</span>block<span class="token punctuation">,</span> input<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">encode</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        longevity<span class="token punctuation">:</span> <span class="token class-name">TransactionLongevity</span><span class="token punctuation">::</span><span class="token function">max_value</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        propagate<span class="token punctuation">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
      _ <span class="token operator">=></span> <span class="token class-name">InvalidTransaction</span><span class="token punctuation">::</span><span class="token class-name">Call</span><span class="token punctuation">.</span><span class="token function">into</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>We add a <code>deprecated</code> attribute to prevent warning messages from being displayed. It is because this part of the API is still in transition and will be updated in coming Substrate release. Please use this with caution for now.</p>
<p><a href="../learn-substrate/extrinsics#unsigned-transactions">Learn more about Unsigned Transactions</a>.</p>
<h2><a class="anchor" aria-hidden="true" id="parameters-in-on-chain-callbacks"></a><a href="#parameters-in-on-chain-callbacks" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Parameters in On-Chain Callbacks</h2>
<p>When making an on-chain callback, our implementation hashes the function name together with all of its parameter values. The callback will be stored and called during the next block import. If we find that the hash value exists, meaning a function with the same set of parameters has been called before, then for signed transactions the function will be replaced if called with a higher priority; for unsigned transactions this callback is simply ignored.</p>
<p>If your pallet is making on-chain callbacks regularly and you expect it to have a duplicate set of parameters occassionally, you can always pass in an additional parameter of the current block number that is passed in from the <code>offchain_worker</code> function. This number will only increment and is guaranteed to be unique.</p>
<h2><a class="anchor" aria-hidden="true" id="fetching-external-data"></a><a href="#fetching-external-data" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Fetching External Data</h2>
<p>To fetch external data from third-party APIs, use the <code>offchain::http</code> library in <code>my_offchain_worker.rs</code> as follows.</p>
<pre><code class="hljs css language-rust"><span class="token keyword">use</span> <span class="token namespace">sp_runtime<span class="token punctuation">::</span></span><span class="token punctuation">{</span>
  <span class="token namespace">offchain<span class="token punctuation">::</span></span>http<span class="token punctuation">,</span>
  <span class="token namespace">transaction_validity<span class="token punctuation">::</span></span><span class="token punctuation">{</span>
    <span class="token class-name">TransactionValidity</span><span class="token punctuation">,</span> <span class="token class-name">TransactionLongevity</span><span class="token punctuation">,</span> <span class="token class-name">ValidTransaction</span><span class="token punctuation">,</span> <span class="token class-name">InvalidTransaction</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>

<span class="token comment">// --snip--</span>

<span class="token macro property">decl_module!</span> <span class="token punctuation">{</span>
  <span class="token keyword">pub</span> <span class="token keyword">struct</span> <span class="token type-definition class-name">Module</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Trait</span><span class="token operator">></span> <span class="token keyword">for</span> <span class="token keyword">enum</span> <span class="token type-definition class-name">Call</span> <span class="token keyword">where</span> origin<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">::</span><span class="token class-name">Origin</span> <span class="token punctuation">{</span>
    <span class="token comment">// --snip--</span>
    <span class="token keyword">fn</span> <span class="token function-definition function">offchain_worker</span><span class="token punctuation">(</span>block<span class="token punctuation">:</span> <span class="token class-name">T</span><span class="token punctuation">::</span><span class="token class-name">BlockNumber</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">match</span> <span class="token keyword">Self</span><span class="token punctuation">::</span><span class="token function">fetch_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Ok</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token macro property">info!</span><span class="token punctuation">(</span><span class="token string">"Result: {}"</span><span class="token punctuation">,</span> <span class="token namespace">core<span class="token punctuation">::</span></span><span class="token keyword">str</span><span class="token punctuation">::</span><span class="token function">from_utf8</span><span class="token punctuation">(</span><span class="token operator">&amp;</span>res<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">unwrap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span>
        <span class="token class-name">Err</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token macro property">error!</span><span class="token punctuation">(</span><span class="token string">"Error fetch_data: {}"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">,</span>
      <span class="token punctuation">}</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">impl</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token punctuation">:</span> <span class="token class-name">Trait</span><span class="token operator">></span> <span class="token class-name">Module</span><span class="token operator">&lt;</span><span class="token class-name">T</span><span class="token operator">></span> <span class="token punctuation">{</span>
  <span class="token keyword">fn</span> <span class="token function-definition function">fetch_data</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">-></span> <span class="token class-name">Result</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">></span><span class="token punctuation">,</span> <span class="token operator">&amp;</span><span class="token lifetime-annotation symbol">'static</span> <span class="token keyword">str</span><span class="token operator">></span> <span class="token punctuation">{</span>

    <span class="token comment">// Specifying the request</span>
    <span class="token keyword">let</span> pending <span class="token operator">=</span> <span class="token namespace">http<span class="token punctuation">::</span></span><span class="token class-name">Request</span><span class="token punctuation">::</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">"https://min-api.cryptocompare.com/data/price?fsym=BTC&amp;tsyms=USD"</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">send</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>_<span class="token closure-punctuation punctuation">|</span></span> <span class="token string">"Error in sending http GET request"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

    <span class="token comment">// Waiting for the response</span>
    <span class="token keyword">let</span> response <span class="token operator">=</span> pending<span class="token punctuation">.</span><span class="token function">wait</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
      <span class="token punctuation">.</span><span class="token function">map_err</span><span class="token punctuation">(</span><span class="token closure-params"><span class="token closure-punctuation punctuation">|</span>_<span class="token closure-punctuation punctuation">|</span></span> <span class="token string">"Error in waiting http response back"</span><span class="token punctuation">)</span><span class="token operator">?</span><span class="token punctuation">;</span>

    <span class="token comment">// Check if the HTTP response is okay</span>
    <span class="token keyword">if</span> response<span class="token punctuation">.</span>code <span class="token operator">!=</span> <span class="token number">200</span> <span class="token punctuation">{</span>
      <span class="token namespace">debug<span class="token punctuation">::</span></span><span class="token macro property">warn!</span><span class="token punctuation">(</span><span class="token string">"Unexpected status code: {}"</span><span class="token punctuation">,</span> response<span class="token punctuation">.</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">return</span> <span class="token class-name">Err</span><span class="token punctuation">(</span><span class="token string">"Non-200 status code returned from http request"</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// Collect the result in the form of bytes</span>
    <span class="token class-name">Ok</span><span class="token punctuation">(</span>response<span class="token punctuation">.</span><span class="token function">body</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">collect</span><span class="token punctuation">::</span><span class="token operator">&lt;</span><span class="token class-name">Vec</span><span class="token operator">&lt;</span><span class="token keyword">u8</span><span class="token operator">>></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<p>You likely need to parse the result in JSON format afterwards. We have <a href="https://github.com/jimmychu0807/substrate-offchain-pricefetch/blob/047ad8094dc21e2bced2d055707756265be32e95/node/runtime/src/price_fetch.rs#L250-L260">an example here</a> using an external library to parse the JSON result in a <code>no_std</code> environment.</p>
<!--
[comment]: # (TODO: Signing Transactions with Session Keys)
[comment]: # (TODO: Local Key-Value Database)
[comment]: # (TODO: Writing Tests)
-->
<h2><a class="anchor" aria-hidden="true" id="后续步骤"></a><a href="#后续步骤" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>后续步骤</h2>
<h3><a class="anchor" aria-hidden="true" id="进一步学习"></a><a href="#进一步学习" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>进一步学习</h3>
<ul>
<li><a href="../learn-substrate/off-chain-features#off-chain-workers">Off-Chain Features Conceptual Guide</a></li>
<li><a href="../learn-substrate/extrinsics#signed-transactions">Signed Transactions</a></li>
<li><a href="../learn-substrate/extrinsics#unsigned-transactions">Unsigned Transactions</a></li>
</ul>
<h3><a class="anchor" aria-hidden="true" id="例子"></a><a href="#例子" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>例子</h3>
<ul>
<li><a href="https://github.com/tomusdrw/sub0-offchain-workshop">Off-chain workers Sub0 workshop materials</a></li>
<li><a href="https://github.com/jimmychu0807/substrate-offchain-pricefetch">Off-chain worker price fetch</a></li>
<li>(Deprecated) <a href="https://github.com/gnunicorn/substrate-offchain-cb">Off-chain worker callback using Substrate v1 API</a></li>
</ul>
<h3><a class="anchor" aria-hidden="true" id="参考文档"></a><a href="#参考文档" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>参考文档</h3>
<ul>
<li>Substrate <a href="https://github.com/paritytech/substrate/blob/master/frame/im-online/src/lib.rs"><code>im-online</code> module</a>, a pallet inside Substrate using off-chain workers to notify other nodes that a validator in the network is online.</li>
</ul>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/docs/zh-CN/knowledgebase/runtime/fees"><span class="arrow-prev">← </span><span>交易费用</span></a><a class="docs-next button" href="/docs/zh-CN/knowledgebase/runtime/debugging"><span>调试</span><span class="arrow-next"> →</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#using-off-chain-workers-in-the-runtime">Using Off-Chain Workers in the Runtime</a></li><li><a href="#insert-keys-in-servicers">Insert Keys in <code>service.rs</code></a><ul class="toc-headings"><li><a href="#选项-1（开发阶段）：添加第一个用户密钥作为应用子密钥">选项 1（开发阶段）：添加第一个用户密钥作为应用子密钥</a></li><li><a href="#option-2-add-an-app-subkey-via-cli">Option 2: Add an App Subkey via CLI</a></li></ul></li><li><a href="#signed-transactions">Signed Transactions</a></li><li><a href="#unsigned-transactions">Unsigned Transactions</a></li><li><a href="#parameters-in-on-chain-callbacks">Parameters in On-Chain Callbacks</a></li><li><a href="#fetching-external-data">Fetching External Data</a></li><li><a href="#后续步骤">后续步骤</a><ul class="toc-headings"><li><a href="#进一步学习">进一步学习</a></li><li><a href="#例子">例子</a></li><li><a href="#参考文档">参考文档</a></li></ul></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/" class="nav-home"><img src="/img/Substrate-logo.svg" alt="Substrate Developer Hub" width="66" height="58"/></a><div><h5>开发者中心</h5><a href="/zh-CN/tutorials">教程</a><a href="/docs/zh-CN/">知识库</a><a href="https://substrate.dev/recipes/">进阶菜谱</a><a href="https://substrate.dev/rustdocs">API 文档</a></div><div><h5>社区</h5><a href="/zh-CN/community">社区主页</a><a href="/zh-CN/newsletter">通讯</a><a href="https://app.element.io/#/room/!HzySYSaIhtyWrwiwEV:matrix.org">Substrate 技术聊天室</a><a href="/zh-CN/seminar">Substrate 研讨会</a><a href="http://stackoverflow.com/questions/tagged/substrate" target="_blank" rel="noreferrer noopener">Stack Overflow</a><a href="https://twitter.com/ParityTech" target="_blank" rel="noreferrer noopener">推特</a><a href="https://www.meetup.com/parity/" target="_blank" rel="noreferrer noopener">聚会活动</a></div><div><h5>更多</h5><a href="https://www.substrate.io/builders-program/">Substrate Builders 计划</a><a href="https://www.parity.io/blog/">Blog</a><a href="https://github.com/paritytech/substrate">Substrate GitHub</a><a href="https://github.com/tetcore/">开发者中心 GitHub</a><a href="https://www.parity.io/privacy/">隐私政策</a><a href="/terms">使用条款</a><a href="#" id="cookie-settings">Cookie 设置<script>
                var cookieSettings = document.getElementById('cookie-settings');
                cookieSettings.onclick = function() {
                  return klaro.show();
                };
              </script></a></div></section><section class="copyright">Copyright © 2021 Parity Technologies</section></footer></div><script type="text/javascript" src="https://cdn.jsdelivr.net/docsearch.js/1/docsearch.min.js"></script><script>
                document.addEventListener('keyup', function(e) {
                  if (e.target !== document.body) {
                    return;
                  }
                  // keyCode for '/' (slash)
                  if (e.keyCode === 191) {
                    const search = document.getElementById('search_input_react');
                    search && search.focus();
                  }
                });
              </script><script>
              var search = docsearch({
                
                apiKey: '5cd09916f4ba4c283b2d45ee7386fc34',
                indexName: 'substrate',
                inputSelector: '#search_input_react',
                algoliaOptions: {"facetFilters":["language:zh-CN"]}
              });
            </script></body></html>